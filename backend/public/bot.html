<!DOCTYPE html>
<html>
<head>
    <title>Zoom SDK Bot</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:,">
</head>
<body>
    <h1>Zoom Bot Initializing...</h1>
    <p id="status">Loading Zoom SDK...</p>

    <script>
        const RETRY_LIMIT = 10;
        let retryCount = 0;

        // --- 1. Get Meeting Credentials from URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const meetingId = urlParams.get('meetingId');
        const password = urlParams.get('password') || '';
        const signature = urlParams.get('signature');
        const userId = urlParams.get('userId');
        const sdkKey = urlParams.get('sdkKey');

        if (!meetingId || !signature || !userId || !sdkKey) {
            const errorMsg = "Missing required parameters: meetingId, signature, userId, or sdkKey";
            document.getElementById('status').textContent = errorMsg;
            console.error(errorMsg);
            throw new Error(errorMsg);
        }

        // --- 2. Configure Bot Identity ---
        const botName = 'AI Assistant';
        const userEmail = `bot+${userId}@zoom-assistant.app`;

        // Variables for recording logic
        let mediaRecorder;
        let audioChunks = [];

        // Function to load scripts dynamically
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = () => {
                console.log(`Loaded: ${src}`);
                if (callback) callback();
            };
            script.onerror = () => {
                console.error(`Failed to load: ${src}`);
            };
            document.head.appendChild(script);
        }

        // Load all required scripts in order
        function loadZoomSDK() {
            document.getElementById('status').textContent = "Loading dependencies...";
            
            // Load React first
            loadScript('https://source.zoom.us/2.18.0/lib/vendor/react.min.js', () => {
                // Load React DOM
                loadScript('https://source.zoom.us/2.18.0/lib/vendor/react-dom.min.js', () => {
                    // Load Redux
                    loadScript('https://source.zoom.us/2.18.0/lib/vendor/redux.min.js', () => {
                        // Load Redux Thunk
                        loadScript('https://source.zoom.us/2.18.0/lib/vendor/redux-thunk.min.js', () => {
                            // Load Lodash
                            loadScript('https://source.zoom.us/2.18.0/lib/vendor/lodash.min.js', () => {
                                // Finally load Zoom SDK
                                loadScript('https://source.zoom.us/2.18.0/zoom-meeting-2.18.0.min.js', () => {
                                    console.log("All scripts loaded, initializing Zoom...");
                                    document.getElementById('status').textContent = "Scripts loaded. Initializing Zoom...";
                                    setTimeout(initializeZoomMeeting, 500);
                                });
                            });
                        });
                    });
                });
            });
        }

        // --- 3. Define Core Bot Functions ---

        /**
         * Called on successful join. Starts recording the meeting's audio stream.
         */
        const startRecording = () => {
            try {
                console.log("Starting recording...");
                document.getElementById('status').textContent = "Successfully joined. Recording audio...";
                
                // Simple recording setup - we'll enhance this later
                // For now, just log that we're "recording"
                console.log("Recording started (placeholder).");
                
            } catch (error) {
                console.error("Error starting recording:", error);
                document.getElementById('status').textContent = "Error: Could not start recording.";
            }
        };

        function initializeZoomMeeting() {
            if (typeof ZoomMtg === 'undefined' && retryCount < RETRY_LIMIT) {
                console.error("ZoomMtg is not defined. Retrying initialization... Attempt:", retryCount + 1);
                document.getElementById('status').textContent = `Retrying initialization... (${retryCount + 1}/${RETRY_LIMIT})`;
                retryCount++;
                setTimeout(initializeZoomMeeting, 2000);
                return;
            }
            
            if (retryCount >= RETRY_LIMIT) {
                const errorMsg = "Failed to initialize Zoom Meeting after multiple attempts.";
                console.error(errorMsg);
                document.getElementById('status').textContent = "Failed to initialize Zoom SDK.";
                return;
            }

            console.log("ZoomMtg is defined. Proceeding with initialization.");
            document.getElementById('status').textContent = "Zoom SDK found. Setting up...";

            try {
                ZoomMtg.setZoomJSLib("https://source.zoom.us/2.18.0/lib", "/av");
                ZoomMtg.preLoadWasm();
                ZoomMtg.prepareWebSDK();

                document.getElementById('status').textContent = "Initializing Zoom SDK...";

                ZoomMtg.init({
                    leaveUrl: "about:blank",
                    success: (success) => {
                        console.log("Zoom SDK initialized successfully");
                        document.getElementById('status').textContent = "Zoom SDK initialized. Joining meeting...";
                        
                        // Add a delay before joining
                        setTimeout(() => {
                            console.log("Attempting to join meeting with:", {
                                meetingId,
                                botName,
                                sdkKey: "***provided***",
                                signature: "***provided***",
                                password: password ? "***provided***" : "empty"
                            });
                            
                            console.log("About to call ZoomMtg.join...");
                            
                            ZoomMtg.join({
                                meetingNumber: meetingId,
                                userName: botName,
                                sdkKey: sdkKey,
                                signature: signature,
                                passWord: password,
                                userEmail: userEmail,
                                success: (result) => {
                                    console.log("Joined meeting successfully!", result);
                                    document.getElementById('status').textContent = "Successfully joined meeting!";
                                    
                                    // Start recording only after a successful join
                                    startRecording();
                                },
                                error: (error) => {
                                    console.error("Join error:", error);
                                    document.getElementById('status').textContent = "Join error: " + JSON.stringify(error);
                                }
                            });
                            
                            console.log("ZoomMtg.join call completed");
                        }, 1000);
                    },
                    error: (error) => {
                        console.error("Init error:", error);
                        document.getElementById('status').textContent = "Init error: " + JSON.stringify(error);
                    }
                });

            } catch (error) {
                console.error("Exception during Zoom initialization:", error);
                document.getElementById('status').textContent = "Exception during initialization: " + error.message;
            }
        }

        // --- 4. Start the Bot ---
        console.log("Starting Zoom SDK loading process...");
        loadZoomSDK();
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        #status {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-weight: bold;
            color: #1976d2;
        }
    </style>
</body>
</html>
